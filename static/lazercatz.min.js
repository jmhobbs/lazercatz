var LC={startScreen:{option:true,keyUp:function(a){if(a.which==38||a.which==40){LC.startScreen.option=!LC.startScreen.option;if(LC.startScreen.option){$("#start-select").css("top","325px").css("left","285px");}else{$("#start-select").css("top","375px").css("left","250px");}}else{if(a.which==32||a.which==13){if(LC.startScreen.option){$("#start-screen").hide();$("#name-screen").show();$("html").die("keyup").live("keyup",LC.nameSelectScreen.keyUp);}else{$("#start-screen").hide();$("#credits-screen").show();$("html").die("keyup").live("keyup",LC.creditsScreen.keyUp);$("#name-input").focus();}}}}},creditsScreen:{keyUp:function(a){if(a.which==32||a.which==13){$("#credits-screen").hide();$("#start-screen").show();$("html").die("keyup").live("keyup",LC.startScreen.keyUp);}}},nameSelectScreen:{keyUp:function(a){if(a.which==13){if($("#name-input").val()==""){$("#name-input").focus();return;}LC.characterSelectScreen.name=$("#name-input").val();$("#name-screen").hide();$("#character-screen").show();$("html").live("keyup",LC.characterSelectScreen.keyUp);}}},characterSelectScreen:{option:2,name:"Bobert",keyUp:function(a){if(a.which==37){--LC.characterSelectScreen.option;}else{if(a.which==39){++LC.characterSelectScreen.option;}else{if(a.which==32||a.which==13){$("#character-screen").hide().remove();$("#game-screen").show();$("html").die("keyup");if(LC.characterSelectScreen.option==1){LC.gameInit("grn",LC.characterSelectScreen.name);}else{if(LC.characterSelectScreen.option==2){LC.gameInit("blu",LC.characterSelectScreen.name);}else{LC.gameInit("red",LC.characterSelectScreen.name);}}return;}}}if(LC.characterSelectScreen.option>3){LC.characterSelectScreen.option=1;}if(LC.characterSelectScreen.option<1){LC.characterSelectScreen.option=3;}if(LC.characterSelectScreen.option==1){$("#character-select").css("left","236px");}else{if(LC.characterSelectScreen.option==2){$("#character-select").css("left","385px");}else{$("#character-select").css("left","535px");}}},},player:function(e,d,c,b,a){this.id=e;this.offset=d;this.sprite=c;this.orientation=b;this.nick=a;this.dead=false;this.health=10;this.charge=10;this.step=true;this.moveLock=false;this.getSprite=function(){if(this.dead){return"dead";}else{return this.sprite+"_"+this.orientation+"_"+((this.step)?"1":"2");}};this.move=function(g,f){this.step=!this.step;this.clear();this.offset=g;this.orientation=f;this.draw();};this.draw=function(){var g=this.offset[0]-LC.map_offset[0],f=this.offset[1]-LC.map_offset[1];if(g<0||g>LC.VIEWPORT_WIDTH-LC.TILE_WIDTH||f<0||f>LC.VIEWPORT_HEIGHT-LC.TILE_HEIGHT){return;}else{LC.drawSprite(this.getSprite(),g,f);}};this.clear=function(){var g=this.offset[0]-LC.map_offset[0],f=this.offset[1]-LC.map_offset[1];if(g<0||g>LC.VIEWPORT_WIDTH-LC.TILE_WIDTH||f<0||f>LC.VIEWPORT_HEIGHT-LC.TILE_HEIGHT){return;}else{LC.clearSprite(g,f);}};this.hit=function(g,f){LC.removeLazer(g);if(LC.user.dead){return;}LC.faye.publish("/hit",{uniqueID:LC.user.id,shooterID:g});this.health=this.health-f;if(this.health<=0){this.health=0;LC.healthBar.css("width","0%");LC.faye.publish("/die",{uniqueID:LC.user.id,killerID:g});LC.user.dead=true;setTimeout(LC.respawn,1000);}else{LC.healthBar.css("width",(this.health*10)+"%");}};},lazer:function(d,e,c,a){this.offset=c;this.sprite="beam_"+d;if(a==LC.user.id){this.sprite="blubeam_"+d;}this.strength=10;this.owner=a;this.move_by=[0,0];this.timer=null;switch(d){case"west":this.move_by[0]=LC.TILE_WIDTH;break;case"east":this.move_by[0]=-1*LC.TILE_WIDTH;break;case"north":this.move_by[1]=-1*LC.TILE_HEIGHT;break;case"south":this.move_by[1]=LC.TILE_HEIGHT;break;}this.draw=function(){if(this.strength<=0){return;}var g=this.offset[0]-LC.map_offset[0],f=this.offset[1]-LC.map_offset[1];if(g<0||g>LC.VIEWPORT_WIDTH-LC.TILE_WIDTH||f<0||f>LC.VIEWPORT_HEIGHT-LC.TILE_HEIGHT){return;}else{LC.drawSprite(this.sprite,g,f);}};this.clear=function(){var g=this.offset[0]-LC.map_offset[0],f=this.offset[1]-LC.map_offset[1];if(g<0||g>LC.VIEWPORT_WIDTH-LC.TILE_WIDTH||f<0||f>LC.VIEWPORT_HEIGHT-LC.TILE_HEIGHT){return;}else{LC.clearSprite(g,f);}};this.move=function(){this.clear();--this.strength;if(0>=this.strength){LC.removeLazer(this.owner);return;}this.offset[0]=this.offset[0]+this.move_by[0];this.offset[1]=this.offset[1]+this.move_by[1];if(this.offset[0]==LC.user.offset[0]&&this.offset[1]==LC.user.offset[1]){this.offset[0]=this.offset[0]-this.move_by[0];this.offset[1]=this.offset[1]-this.move_by[1];LC.user.hit(this.owner,this.strength);return;}this.draw();var f=this;this.timer=setTimeout(function(){f.move();},50);};this.offset[0]=this.offset[0]+this.move_by[0];this.offset[1]=this.offset[1]+this.move_by[1];if(this.offset[0]==LC.user.offset[0]&&this.offset[1]==LC.user.offset[1]){this.offset[0]=this.offset[0]-this.move_by[0];this.offset[1]=this.offset[1]-this.move_by[1];LC.user.hit(this.owner,this.strength);return;}this.draw();var b=this;this.timer=setTimeout(function(){b.move();},50);},TILE_WIDTH:40,TILE_HEIGHT:40,MAP_WIDTH:2000,MAP_HEIGHT:2000,VIEWPORT_WIDTH:640,VIEWPORT_HEIGHT:600,MOVE_BUFFER_HIGH:540,MOVE_BUFFER_LOW:100,sprite_map:{dead:[0,160,40,40],grn_south_1:[0,0,40,40],grn_south_2:[40,0,40,40],grn_north_1:[80,0,40,40],grn_north_2:[120,0,40,40],grn_east_1:[160,0,40,40],grn_east_2:[200,0,40,40],grn_west_1:[240,0,40,40],grn_west_2:[280,0,40,40],blu_south_1:[0,40,40,40],blu_south_2:[40,40,40,40],blu_north_1:[80,40,40,40],blu_north_2:[120,40,40,40],blu_east_1:[160,40,40,40],blu_east_2:[200,40,40,40],blu_west_1:[240,40,40,40],blu_west_2:[280,40,40,40],red_south_1:[0,80,40,40],red_south_2:[40,80,40,40],red_north_1:[80,80,40,40],red_north_2:[120,80,40,40],red_east_1:[160,80,40,40],red_east_2:[200,80,40,40],red_west_1:[240,80,40,40],red_west_2:[280,80,40,40],beam_south:[0,120,40,40],beam_north:[80,120,40,40],beam_east:[160,120,40,40],beam_west:[240,120,40,40],blubeam_south:[40,120,40,40],blubeam_north:[120,120,40,40],blubeam_east:[200,120,40,40],blubeam_west:[280,120,40,40]},ctx:null,map:null,sprites:null,faye:null,messages:null,users:null,healthBar:null,powerBar:null,pew:null,map_offset:[0,0],user:null,players:[],lazers:[],init:function(){$("html").live("keyup",LC.startScreen.keyUp);},gameInit:function(b,a){LC.ctx=document.getElementById("objects").getContext("2d");LC.map=$("#map");LC.messages=$("#messages");LC.users=$("#userList").find("ul");LC.sprites=document.getElementById("sprites");$("html").die("keyup").live("keyup",LC.keyUp);LC.healthBar=$("#health").find(".remaining");LC.powerBar=$("#ammo").find(".remaining");$.getJSON("/init.json",{nick:a},function(d){LC.user=new LC.player(d.you.uniqueID,d.you.offset,b,"south",d.you.nick);LC.user.dead=true;LC.faye=new Faye.Client("http://"+window.location.hostname+":"+d.you.port+"/faye",{timeout:120});window.onbeforeunload=LC.quit;for(var e=0;e<d.them.length;e++){var c=d.them[e];if(c.uniqueID!=LC.user.id){LC.players[c.uniqueID]=new LC.player(c.uniqueID,c.offset,"blu",c.orientation,c.nick);LC.users.append($("<li></li>").text(c.nick+": "+c.kills+" kills").addClass(c.uniqueID));}}LC.message(LC.user.nick+" joined the game");LC.users.append($("<li></li>").text(LC.user.nick+": 0 kills").addClass(LC.user.id));LC.players[LC.user.id]=LC.user;LC.faye.subscribe("/join",function(f){if(f.uniqueID!=LC.user.id){LC.message(f.nick+" joined the game");LC.users.append($("<li></li>").text(f.nick+": "+f.kills+" kills").addClass(f.uniqueID));LC.players[f.uniqueID]=new LC.player(f.uniqueID,f.offset,"red","south",f.nick);LC.players[f.uniqueID].draw();}});LC.faye.subscribe("/move",function(f){if(f.uniqueID!=LC.user.id){LC.players[f.uniqueID].move(f.offset,f.orientation);}});LC.faye.subscribe("/quit",function(f){LC.message(LC.players[f.uniqueID].nick+" quit the game");LC.users.find("."+f.uniqueID).remove();LC.players[f.uniqueID].clear();delete LC.players[f.uniqueID];});LC.faye.subscribe("/fire",function(f){if(f.uniqueID!=LC.user.id){LC.removeLazer(f.uniqueID);LC.lazers[f.uniqueID]=new LC.lazer(f.orientation,f.strength,f.origin,f.uniqueID);}});LC.faye.subscribe("/hit",function(f){LC.removeLazer(f.shooterID);LC.players[f.uniqueID].clear();LC.players[f.uniqueID].draw();});LC.faye.subscribe("/die",function(f){LC.message(LC.players[f.killerID].nick+" killed "+LC.players[f.uniqueID].nick);LC.players[f.uniqueID].clear();LC.players[f.uniqueID].dead=true;LC.players[f.uniqueID].draw();});LC.faye.subscribe("/spawn",function(f){LC.players[f.uniqueID].clear();LC.players[f.uniqueID].dead=false;LC.players[f.uniqueID].offset[0]=f.offset[0];LC.players[f.uniqueID].offset[1]=f.offset[1];LC.players[f.uniqueID].draw();});LC.faye.subscribe("/leaderboard",function(h){var g="";for(var f=0;f<h.length;f++){g+="<li class='"+h[f].uniqueID+"'>"+h[f].nick+": "+h[f].kills+" kills</li>";}LC.users.html(g);});LC.spawn();});},soundReady:function(){LC.pew=soundManager.createSound({id:"pew-pew-pew",url:"pew.mp3"});},message:function(a){LC.messages.html(a+"<br/>"+LC.messages.html());},quit:function(){$.ajax({url:"/quit.json",dataType:"json",data:{uniqueID:LC.user.id},async:false,success:function(){alert("Thanks For Playing!\nPlease Take A Moment To Vote For Us!\nhttp://nodeknockout.com/teams/lazercatz");}});},clearSprite:function(a,b){LC.ctx.clearRect(a,b,LC.TILE_WIDTH,LC.TILE_HEIGHT);},drawSprite:function(b,a,c){LC.ctx.clearRect(a,c,LC.TILE_WIDTH,LC.TILE_HEIGHT);LC.ctx.drawImage(LC.sprites,LC.sprite_map[b][0],LC.sprite_map[b][1],LC.sprite_map[b][2],LC.sprite_map[b][3],a,c,LC.sprite_map[b][2],LC.sprite_map[b][3]);},moveMap:function(a,b){LC.map_offset[0]=LC.map_offset[0]+a;LC.map_offset[1]=LC.map_offset[1]+b;if(LC.map_offset[0]<0){LC.map_offset[0]=0;}if(LC.map_offset[1]<0){LC.map_offset[1]=0;}if(LC.map_offset[0]>=(LC.MAP_WIDTH-LC.VIEWPORT_WIDTH)){LC.map_offset[0]=LC.MAP_WIDTH-LC.VIEWPORT_WIDTH;}if(LC.map_offset[1]>=(LC.MAP_HEIGHT-LC.VIEWPORT_HEIGHT)){LC.map_offset[1]=LC.MAP_HEIGHT-LC.VIEWPORT_HEIGHT;}LC.map.css("background-position","-"+LC.map_offset[0]+"px -"+LC.map_offset[1]+"px");},keyUp:function(a){if(LC.user.dead){return;}switch(a.which){case 37:LC.moveUser("w");break;case 38:LC.moveUser("n");break;case 39:LC.moveUser("e");break;case 40:LC.moveUser("s");break;case 32:LC.fire();}},removeLazer:function(a){if("undefined"!=typeof(LC.lazers[a])){clearTimeout(LC.lazers[a].timer);LC.lazers[a].clear();delete LC.lazers[a];}},spawn:function(){for(var a in LC.players){if(a!=LC.user.id){LC.players[a].clear();}}LC.user.clear();LC.moveMap(-1*LC.map_offset[0],-1*LC.map_offset[1]);LC.moveMap(LC.user.offset[0]-260,LC.user.offset[1]-260);LC.user.dead=false;LC.user.health=10;LC.healthBar.css("width","100%");LC.user.draw();for(var a in LC.players){if(a!=LC.user.id){LC.players[a].draw();}}LC.faye.publish("/spawn",{uniqueID:LC.user.id,offset:LC.user.offset});},moveUser:function(c){if(LC.user.dead||LC.user.moveLock){return;}LC.user.moveLock=true;var a=$.extend({},LC.user.offset);switch(c){case"w":a[0]=LC.user.offset[0]-LC.TILE_HEIGHT;new_orientation="east";break;case"e":a[0]=LC.user.offset[0]+LC.TILE_HEIGHT;new_orientation="west";break;case"n":a[1]=LC.user.offset[1]-LC.TILE_WIDTH;new_orientation="north";break;case"s":a[1]=LC.user.offset[1]+LC.TILE_WIDTH;new_orientation="south";break;}if(a[0]>=LC.MAP_WIDTH||a[1]>=LC.MAP_HEIGHT||a[0]<0||a[1]<0){LC.user.moveLock=false;return;}for(var b in LC.players){if(b!=LC.user.id&&LC.players[b].offset[0]==a[0]&&LC.players[b].offset[1]==a[1]){LC.user.moveLock=false;return;}}for(var b in LC.lazers){if(b!=LC.user.id&&LC.lazers[b].offset[0]==a[0]&&LC.lazers[b].offset[1]==a[1]){LC.user.moveLock=false;return;}}LC.user.clear();for(var b in LC.players){if(b!=LC.user.id){LC.players[b].clear();}}for(var b in LC.lazers){LC.lazers[b].clear();}LC.user.offset=a;LC.user.orientation=new_orientation;edge_proximity=[(LC.map_offset[0]+LC.VIEWPORT_WIDTH-LC.user.offset[0]),(LC.map_offset[1]+LC.VIEWPORT_HEIGHT-LC.user.offset[1])];if("e"==c&&edge_proximity[0]<=LC.MOVE_BUFFER_LOW){LC.moveMap(LC.TILE_WIDTH,0);}if("w"==c&&edge_proximity[0]>=LC.MOVE_BUFFER_HIGH){LC.moveMap(-1*LC.TILE_WIDTH,0);}if("n"==c&&edge_proximity[1]>=LC.MOVE_BUFFER_HIGH){LC.moveMap(0,-1*LC.TILE_HEIGHT);}if("s"==c&&edge_proximity[1]<=LC.MOVE_BUFFER_LOW){LC.moveMap(0,LC.TILE_HEIGHT);}LC.user.step=!LC.user.step;LC.user.draw();for(var b in LC.players){if(b!=LC.user.id){LC.players[b].draw();}}for(var b in LC.lazers){LC.lazers[b].draw();}LC.faye.publish("/move",{offset:LC.user.offset,uniqueID:LC.user.id,orientation:LC.user.orientation});setTimeout(function(){LC.user.moveLock=false;},150);},fire:function(){if(LC.user.dead||LC.user.charge<10){return;}LC.pew.play();LC.user.charge=0;LC.removeLazer(LC.user.id);var b=$.extend({},LC.user.offset),a=$.extend({},LC.user.offset);LC.powerBar.css("width","0%");LC.lazers[LC.user.id]=new LC.lazer(LC.user.orientation,10,b,LC.user.id);LC.faye.publish("/fire",{origin:a,uniqueID:LC.user.id,orientation:LC.user.orientation,strength:5});setTimeout(LC.recharge,100);},recharge:function(){++LC.user.charge;LC.powerBar.css("width",(LC.user.charge*10)+"%");if(LC.user.charge==10){return;}else{setTimeout(LC.recharge,100);}},respawn:function(){LC.user.health=LC.user.health+2;if(LC.user.health>=10){LC.spawn();}else{LC.message("Respawn in "+((10-LC.user.health)/2)+"...");setTimeout(LC.respawn,1000);}}};