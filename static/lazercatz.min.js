var Player=function(e,d,c,b,a){this.id=e;this.sprite=c;this.orientation=b;this.nick=a;this.offset=$.extend({},d);this.lastDrawnOffset=$.extend({},d);this.dirty=true;this.health=10;this.charge=10;this.step=true;this.dead=function(){return(this.health<=0)};this.getSprite=function(){if(this.dead()){return"dead"}else{return this.sprite+"_"+this.orientation+"_"+((this.step)?"1":"2")}};this.move=function(g,f){this.step=!this.step;this.offset=g;this.orientation=f;this.dirty=true};this.clear=function(h){h=("undefined"==typeof(h))?false:h;if(this.dirty||h){var g=this.lastDrawnOffset[0]-LC.map_offset[0],f=this.lastDrawnOffset[1]-LC.map_offset[1];if(LC.inViewport(g,f)){LC.clearSprite(g,f)}}};this.draw=function(h){h=("undefined"==typeof(h))?false:h;if(this.dirty||h){var g=this.offset[0]-LC.map_offset[0],f=this.offset[1]-LC.map_offset[1];if(LC.inViewport(g,f)){LC.drawSprite(this.getSprite(),g,f);this.dirty=false;this.lastDrawnOffset=$.extend({},this.offset)}}}};var Lazer=function(c,d,b,a){this.offset=b;this.sprite="beam_"+c;if(a==LC.user.id){this.sprite="blubeam_"+c}this.strength=d;this.owner=a;this.move_by=[0,0];switch(c){case"west":this.move_by[0]=LC.TILE_WIDTH;break;case"east":this.move_by[0]=-1*LC.TILE_WIDTH;break;case"north":this.move_by[1]=-1*LC.TILE_HEIGHT;break;case"south":this.move_by[1]=LC.TILE_HEIGHT;break}this.offset[0]=this.offset[0]+this.move_by[0];this.offset[1]=this.offset[1]+this.move_by[1];this.move=function(){--this.strength;if(0>=this.strength){LC.removeLazer(this.owner);return}this.offset[0]=this.offset[0]+this.move_by[0];this.offset[1]=this.offset[1]+this.move_by[1];if(this.offset[0]==LC.user.offset[0]&&this.offset[1]==LC.user.offset[1]){this.offset[0]=this.offset[0]-this.move_by[0];this.offset[1]=this.offset[1]-this.move_by[1];LC.hit(this.owner,this.strength);return}};this.clear=function(){var f=this.offset[0]-LC.map_offset[0],e=this.offset[1]-LC.map_offset[1];if(LC.inViewport(f,e)){LC.clearSprite(f,e)}};this.draw=function(){var f=this.offset[0]-LC.map_offset[0],e=this.offset[1]-LC.map_offset[1];if(LC.inViewport(f,e)){LC.drawSprite(this.sprite,f,e)}}};var LC={TILE_WIDTH:40,TILE_HEIGHT:40,MAP_WIDTH:2000,MAP_HEIGHT:2000,VIEWPORT_WIDTH:640,VIEWPORT_HEIGHT:600,MOVE_BUFFER_HIGH:540,MOVE_BUFFER_LOW:100,sprite_map:{dead:[0,160,40,40],grn_south_1:[0,0,40,40],grn_south_2:[40,0,40,40],grn_north_1:[80,0,40,40],grn_north_2:[120,0,40,40],grn_east_1:[160,0,40,40],grn_east_2:[200,0,40,40],grn_west_1:[240,0,40,40],grn_west_2:[280,0,40,40],blu_south_1:[0,40,40,40],blu_south_2:[40,40,40,40],blu_north_1:[80,40,40,40],blu_north_2:[120,40,40,40],blu_east_1:[160,40,40,40],blu_east_2:[200,40,40,40],blu_west_1:[240,40,40,40],blu_west_2:[280,40,40,40],red_south_1:[0,80,40,40],red_south_2:[40,80,40,40],red_north_1:[80,80,40,40],red_north_2:[120,80,40,40],red_east_1:[160,80,40,40],red_east_2:[200,80,40,40],red_west_1:[240,80,40,40],red_west_2:[280,80,40,40],beam_south:[0,120,40,40],beam_north:[80,120,40,40],beam_east:[160,120,40,40],beam_west:[240,120,40,40],blubeam_south:[40,120,40,40],blubeam_north:[120,120,40,40],blubeam_east:[200,120,40,40],blubeam_west:[280,120,40,40]},ctx:null,map:null,sprites:null,faye:null,messages:null,users:null,healthBar:null,powerBar:null,pew:null,map_offset:[0,0],user:null,players:[],lazers:[],moveLock:false,init:function(){$("html").live("keyup",LC.loadingScreens.start.keyUp)},gameInit:function(b,a){LC.ctx=document.getElementById("objects").getContext("2d");LC.map=$("#map");LC.messages=$("#messages");LC.users=$("#userList").find("ul");LC.sprites=document.getElementById("sprites");LC.healthBar=$("#health").find(".remaining");LC.powerBar=$("#ammo").find(".remaining");$("html").die("keyup").live("keyup",LC.keyUp);$.getJSON("/init.json",{nick:a,skin:b},function(d){LC.user=new Player(d.you.uniqueID,d.you.offset,b,"south",d.you.nick);LC.user.health=0;LC.faye=new Faye.Client("http://"+window.location.hostname+":"+d.you.port+"/faye",{timeout:120});window.onbeforeunload=LC.quit;for(var e=0;e<d.them.length;e++){var c=d.them[e];if(c.uniqueID!=LC.user.id){LC.players[c.uniqueID]=new Player(c.uniqueID,c.offset,c.skin,c.orientation,c.nick);LC.users.append($("<li></li>").text(c.nick+": "+c.kills+" kills").addClass(c.uniqueID))}}LC.players[LC.user.id]=LC.user;LC.users.append($("<li></li>").text(LC.user.nick+": 0 kills").addClass(LC.user.id));LC.message(LC.user.nick+" joined the game");LC.faye.subscribe("/join",LC.events.join);LC.faye.subscribe("/move",LC.events.move);LC.faye.subscribe("/quit",LC.events.quit);LC.faye.subscribe("/fire",LC.events.fire);LC.faye.subscribe("/hit",LC.events.hit);LC.faye.subscribe("/die",LC.events.die);LC.faye.subscribe("/spawn",LC.events.spawn);LC.faye.subscribe("/leaderboard",LC.events.leaderboard);LC.spawn();LC.mainLoop()})},soundReady:function(){LC.pew=soundManager.createSound({id:"pew-pew-pew",url:"pew.mp3"})},message:function(a){LC.messages.html(a+"<br/>"+LC.messages.html())},quit:function(){$.ajax({url:"/quit.json",dataType:"json",data:{uniqueID:LC.user.id},async:false,success:function(){alert("Thanks For Playing!")}})},clearSprite:function(a,b){LC.ctx.clearRect(a,b,LC.TILE_WIDTH,LC.TILE_HEIGHT)},drawSprite:function(b,a,c){LC.ctx.clearRect(a,c,LC.TILE_WIDTH,LC.TILE_HEIGHT);LC.ctx.drawImage(LC.sprites,LC.sprite_map[b][0],LC.sprite_map[b][1],LC.sprite_map[b][2],LC.sprite_map[b][3],a,c,LC.sprite_map[b][2],LC.sprite_map[b][3])},inViewport:function(a,b){return !(a<0||a>LC.VIEWPORT_WIDTH-LC.TILE_WIDTH||b<0||b>LC.VIEWPORT_HEIGHT-LC.TILE_HEIGHT)},moveMap:function(a,b){LC.map_offset[0]=LC.map_offset[0]+a;LC.map_offset[1]=LC.map_offset[1]+b;if(LC.map_offset[0]<0){LC.map_offset[0]=0}if(LC.map_offset[1]<0){LC.map_offset[1]=0}if(LC.map_offset[0]>=(LC.MAP_WIDTH-LC.VIEWPORT_WIDTH)){LC.map_offset[0]=LC.MAP_WIDTH-LC.VIEWPORT_WIDTH}if(LC.map_offset[1]>=(LC.MAP_HEIGHT-LC.VIEWPORT_HEIGHT)){LC.map_offset[1]=LC.MAP_HEIGHT-LC.VIEWPORT_HEIGHT}LC.map.css("background-position","-"+LC.map_offset[0]+"px -"+LC.map_offset[1]+"px")},keyUp:function(a){if(LC.user.dead()){return}switch(a.which){case 37:LC.move("w");break;case 38:LC.move("n");break;case 39:LC.move("e");break;case 40:LC.move("s");break;case 32:LC.fire()}},mainLoop:function(){var a=[(LC.map_offset[0]+LC.VIEWPORT_WIDTH-LC.user.offset[0]),(LC.map_offset[1]+LC.VIEWPORT_HEIGHT-LC.user.offset[1])];var b=(a[0]<=LC.MOVE_BUFFER_LOW||a[0]>=LC.MOVE_BUFFER_HIGH||a[1]>=LC.MOVE_BUFFER_HIGH||a[1]<=LC.MOVE_BUFFER_LOW);for(var c in LC.players){LC.players[c].clear(b)}for(var c in LC.lazers){LC.lazers[c].clear()}if(a[0]<=LC.MOVE_BUFFER_LOW){LC.moveMap(LC.TILE_WIDTH,0)}if(a[0]>=LC.MOVE_BUFFER_HIGH){LC.moveMap(-1*LC.TILE_WIDTH,0)}if(a[1]>=LC.MOVE_BUFFER_HIGH){LC.moveMap(0,-1*LC.TILE_HEIGHT)}if(a[1]<=LC.MOVE_BUFFER_LOW){LC.moveMap(0,LC.TILE_HEIGHT)}for(var c in LC.lazers){LC.lazers[c].move()}for(var c in LC.lazers){LC.lazers[c].draw()}for(var c in LC.players){LC.players[c].draw(b)}if(LC.user.charge<10){LC.user.charge=LC.user.charge+0.5;LC.powerBar.css("width",Math.floor(LC.user.charge*10)+"%")}if(LC.user.health<0){LC.user.health=LC.user.health+1;if(LC.user.health==0){LC.healthBar.css("width","100%");LC.user.health=10;LC.user.charge=10;LC.user.dirty=true;LC.message("Respawn!");LC.faye.publish("/spawn",{uniqueID:LC.user.id,offset:LC.user.offset});LC.spawn()}else{LC.healthBar.css("width",100-Math.floor(Math.abs(LC.user.health)/4*10)+"%")}}setTimeout(LC.mainLoop,50)},move:function(b){LC.moveLock=true;var a=$.extend({},LC.user.offset);switch(b){case"w":a[0]=LC.user.offset[0]-LC.TILE_HEIGHT;new_orientation="east";break;case"e":a[0]=LC.user.offset[0]+LC.TILE_HEIGHT;new_orientation="west";break;case"n":a[1]=LC.user.offset[1]-LC.TILE_WIDTH;new_orientation="north";break;case"s":a[1]=LC.user.offset[1]+LC.TILE_WIDTH;new_orientation="south";break}if(a[0]>=LC.MAP_WIDTH||a[1]>=LC.MAP_HEIGHT||a[0]<0||a[1]<0){LC.moveLock=false;return}for(var c in LC.players){if(c!=LC.user.id&&LC.players[c].offset[0]==a[0]&&LC.players[c].offset[1]==a[1]){a=$.extend({},LC.user.offset);break}}for(var c in LC.lazers){if(c!=LC.user.id&&LC.lazers[c].offset[0]==a[0]&&LC.lazers[c].offset[1]==a[1]){a=$.extend({},LC.user.offset);break}}LC.user.offset=a;LC.user.orientation=new_orientation;LC.user.dirty=true;LC.faye.publish("/move",{offset:LC.user.offset,uniqueID:LC.user.id,orientation:LC.user.orientation});setTimeout(function(){LC.moveLock=false},150)},spawn:function(){LC.user.health=10;LC.healthBar.css("width","100%");LC.faye.publish("/spawn",{uniqueID:LC.user.id,offset:LC.user.offset})},removeLazer:function(a){if("undefined"!=typeof(LC.lazers[a])){LC.lazers[a].clear(true);delete LC.lazers[a]}},hit:function(b,a){LC.removeLazer(b);LC.faye.publish("/hit",{uniqueID:LC.user.id,shooterID:b});if(LC.user.dead()){return}LC.user.health=LC.user.health-a;if(LC.user.dead()){LC.user.health=-40;LC.healthBar.css("width","0%");LC.faye.publish("/die",{uniqueID:LC.user.id,killerID:b})}else{LC.healthBar.css("width",(LC.user.health*10)+"%")}},fire:function(){if(LC.user.dead()||LC.user.charge<10){return}LC.pew.play();LC.user.charge=0;LC.removeLazer(LC.user.id);var b=$.extend({},LC.user.offset),a=$.extend({},LC.user.offset);LC.powerBar.css("width","0%");LC.lazers[LC.user.id]=new Lazer(LC.user.orientation,10,b,LC.user.id);LC.faye.publish("/fire",{origin:a,uniqueID:LC.user.id,orientation:LC.user.orientation,strength:10})},events:{join:function(a){if(a.uniqueID!=LC.user.id){LC.message(a.nick+" joined the game");LC.users.append($("<li></li>").text(a.nick+": "+a.kills+" kills").addClass(a.uniqueID));LC.players[a.uniqueID]=new Player(a.uniqueID,a.offset,a.skin,a.orientation,a.nick)}},move:function(a){if(a.uniqueID!=LC.user.id){LC.players[a.uniqueID].move(a.offset,a.orientation)}},quit:function(a){LC.message(LC.players[a.uniqueID].nick+" quit the game");LC.users.find("."+a.uniqueID).remove();LC.players[a.uniqueID].clear(true);if(LC.user.id==a.uniqueID){alert("Oops! You got booted from the server!\n\nThis happens if you stop moving around for a while.\n\nRefresh To Start A New Game")}delete LC.players[a.uniqueID]},fire:function(a){if(a.uniqueID!=LC.user.id){LC.removeLazer(a.uniqueID);LC.lazers[a.uniqueID]=new Lazer(a.orientation,a.strength,a.origin,a.uniqueID)}},hit:function(a){LC.removeLazer(a.shooterID);LC.players[a.uniqueID].dirty=true},die:function(a){LC.message(LC.players[a.killerID].nick+" killed "+LC.players[a.uniqueID].nick);LC.players[a.uniqueID].dirty=true;if(a.uniqueID!=LC.user.id){LC.players[a.uniqueID].health=0}},spawn:function(a){if(a.uniqueID!=LC.user.id){LC.players[a.uniqueID].health=10;LC.players[a.uniqueID].dirty=true}},leaderboard:function(c){var b="";for(var a=0;a<c.length;a++){b+="<li class='"+c[a].uniqueID+"'>"+c[a].nick+": "+c[a].kills+" kills</li>"}LC.users.html(b)}},loadingScreens:{start:{option:true,keyUp:function(a){if(a.which==38||a.which==40){LC.loadingScreens.start.option=!LC.loadingScreens.start.option;if(LC.loadingScreens.start.option){$("#start-select").css("top","325px").css("left","285px")}else{$("#start-select").css("top","375px").css("left","250px")}}else{if(a.which==32||a.which==13){if(LC.loadingScreens.start.option){$("#start-screen").hide();$("#name-screen").show();$("html").die("keyup").live("keyup",LC.loadingScreens.name.keyUp);$("#name-input").focus()}else{$("#start-screen").hide();$("#credits-screen").show();$("html").die("keyup").live("keyup",LC.loadingScreens.credits.keyUp)}}}}},credits:{keyUp:function(a){if(a.which==32||a.which==13){$("#credits-screen").hide();$("#start-screen").show();$("html").die("keyup").live("keyup",LC.loadingScreens.start.keyUp)}}},name:{keyUp:function(a){if(a.which==13){if($("#name-input").val()==""){$("#name-input").focus();return}LC.loadingScreens.character.name=$("#name-input").val();$("#name-screen").hide();$("#character-screen").show();$("html").live("keyup",LC.loadingScreens.character.keyUp)}}},character:{option:2,name:"Bobert",keyUp:function(a){if(a.which==37){--LC.loadingScreens.character.option}else{if(a.which==39){++LC.loadingScreens.character.option}else{if(a.which==32||a.which==13){$("#character-screen").hide().remove();$("#game-screen").show();$("html").die("keyup");if(LC.loadingScreens.character.option==1){LC.gameInit("grn",LC.loadingScreens.character.name)}else{if(LC.loadingScreens.character.option==2){LC.gameInit("blu",LC.loadingScreens.character.name)}else{LC.gameInit("red",LC.loadingScreens.character.name)}}return}}}if(LC.loadingScreens.character.option>3){LC.loadingScreens.character.option=1}if(LC.loadingScreens.character.option<1){LC.loadingScreens.character.option=3}if(LC.loadingScreens.character.option==1){$("#character-select").css("left","236px")}else{if(LC.loadingScreens.character.option==2){$("#character-select").css("left","385px")}else{$("#character-select").css("left","535px")}}},},}};
